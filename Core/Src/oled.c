#include "oled.h"
#include <stdint.h>


unsigned char screenBuff[BUFF_SIZE]; //
uint8_t cmdBuff[WIRE_MAX];
I2C_HandleTypeDef *i2c1;

static void write_cmd(uint8_t c) ; 
static void cmd_list(unsigned char *c, int n); 
static void initDisplay(); 
static void drawpixel(int x, int y); 
static void display(); 

uint8_t logo_bmp[] =
{ 0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x1f,0xff,0xff,0xf0,
  0x00,0x00,0x3f,0xff,0xff,0xf0,
  0x00,0x00,0x3f,0xff,0xff,0xf0,
  0x00,0x00,0x3f,0xff,0xff,0xf0,
  0x00,0x00,0x3e,0x6f,0xe4,0xf0,
  0x00,0x00,0x3e,0xa7,0x20,0xf0,
  0x00,0x40,0x3e,0x0b,0x21,0xf0,
  0x01,0xf0,0x3e,0x83,0x20,0xf0,
  0x00,0xe0,0x3e,0x53,0x64,0xf0,
  0x00,0xe0,0x3f,0xff,0xff,0xf0,
  0x00,0x00,0x3f,0xff,0xff,0xf0,
  0x00,0x00,0x3f,0xff,0xff,0xf0,
  0x00,0x00,0x3f,0xff,0xef,0xf0,
  0x00,0x00,0x3f,0xfc,0xff,0xf0,
  0x00,0x00,0x3f,0xff,0x5f,0xf0,
  0x00,0x00,0x3f,0xef,0xbf,0xf0,
  0x00,0x00,0x3f,0xff,0xbf,0xf0,
  0x00,0x00,0x3f,0x73,0xef,0xf0,
  0x00,0x00,0x3d,0xdb,0xff,0xf0,
  0x00,0x00,0x3b,0x7e,0xff,0xf0,
  0x00,0x00,0x0d,0xfd,0xff,0xf0,
  0x00,0x00,0x1b,0xef,0xff,0xf0,
  0x00,0x00,0x6f,0xfb,0xff,0xf0,
  0x00,0x00,0xbf,0xdf,0xff,0xf0,
  0x00,0x00,0x3f,0xff,0xff,0xf0,
  0x00,0x00,0x3f,0xaf,0xff,0xf0,
  0x00,0x00,0x3f,0xff,0xff,0xf0,
  0x00,0x00,0x3f,0x5f,0xff,0xf0,
  0x00,0x00,0x3f,0xbf,0xff,0xf0,
  0x00,0x00,0x3e,0xff,0xff,0xf0,
  0x00,0x00,0xef,0xef,0xff,0xf0,
  0x00,0x00,0xfc,0xff,0xff,0xf0,
  0x00,0x01,0x3f,0xff,0xff,0xf0,
  0x00,0x14,0x39,0xff,0xff,0xf0,
  0x00,0x18,0x3b,0xff,0xff,0xf0,
  0x00,0x30,0x37,0xff,0xff,0xf0,
  0x00,0x10,0x37,0xff,0xff,0xf0,
  0x00,0x00,0x2f,0xff,0xff,0xf0,
  0x00,0x00,0x0f,0xff,0xff,0xf0,
  0x00,0x00,0x1f,0xff,0xff,0xf0,
  0x00,0x00,0x3f,0xff,0xff,0xf0,
  0x00,0x10,0x3f,0xff,0xff,0xf0,
  0x00,0x30,0x3f,0xff,0xff,0xf0,
  0x00,0x38,0x3f,0xff,0xff,0xf0,
  0x00,0x18,0x3f,0xff,0xff,0xf0,
  0x00,0x00,0x3f,0xff,0xff,0xf0,
  0x00,0x01,0x3f,0xff,0xff,0xf0,
  0x00,0x00,0xef,0xff,0xff,0xf0,
  0x00,0x00,0xef,0xff,0xff,0xf0,
  0x00,0x00,0x3f,0xff,0xff,0xf0,
  0x00,0x00,0x3f,0xff,0xff,0xf0,
  0x00,0x00,0x3f,0xff,0xff,0xf0,
  0x00,0x00,0x1f,0xff,0xff,0xf0,
  0x3f,0xff,0xdf,0xff,0xff,0xf0,
  0x3f,0xdf,0xff,0xff,0xff,0xf0,
  0x3f,0xdf,0xff,0xff,0xff,0xf0,
  0x30,0x88,0x13,0x02,0x04,0x70,
  0x30,0x88,0x13,0x02,0x04,0x70,
  0x30,0x89,0x03,0x10,0x04,0x70,
  0x30,0x89,0x83,0x10,0x04,0x70,
  0x30,0x00,0x13,0x02,0x00,0x30,
  0x30,0x20,0x13,0x02,0x01,0x30,
  0x3b,0xac,0xb7,0xea,0xcf,0x70,
  0x3f,0xff,0xff,0xff,0xff,0xf0,
  0x3f,0xff,0xff,0xff,0xff,0xf0,
  0x00,0x00,0x00,0x00,0x00,0x00,

};

// rong 128 dai 64
const uint8_t Fonts_10x7 [] = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // sp
0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00, 0x10, 0x00, 0x00,  // !
0x28, 0x28, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // "
0x24, 0x24, 0x7C, 0x24, 0x48, 0x7C, 0x48, 0x48, 0x00, 0x00,  // #
0x38, 0x54, 0x50, 0x38, 0x14, 0x54, 0x54, 0x38, 0x10, 0x00,  // $
0x20, 0x54, 0x58, 0x30, 0x28, 0x54, 0x14, 0x08, 0x00, 0x00,  // %
0x10, 0x28, 0x28, 0x10, 0x34, 0x48, 0x48, 0x34, 0x00, 0x00,  // &
0x10, 0x10, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // '
0x08, 0x10, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x10, 0x08,  // (
0x20, 0x10, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x10, 0x20,  // )
0x10, 0x38, 0x10, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // *
0x00, 0x00, 0x10, 0x10, 0x7C, 0x10, 0x10, 0x00, 0x00, 0x00,  // +
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x10, 0x10,  // ,
0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x00, 0x00, 0x00, 0x00,  // -
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00,  // .
0x08, 0x08, 0x10, 0x10, 0x10, 0x10, 0x20, 0x20, 0x00, 0x00,  // /
0x38, 0x44, 0x44, 0x54, 0x44, 0x44, 0x44, 0x38, 0x00, 0x00,  // 0
0x10, 0x30, 0x50, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00, 0x00,  // 1
0x38, 0x44, 0x44, 0x04, 0x08, 0x10, 0x20, 0x7C, 0x00, 0x00,  // 2
0x38, 0x44, 0x04, 0x18, 0x04, 0x04, 0x44, 0x38, 0x00, 0x00,  // 3
0x08, 0x18, 0x28, 0x28, 0x48, 0x7C, 0x08, 0x08, 0x00, 0x00,  // 4
0x7C, 0x40, 0x40, 0x78, 0x04, 0x04, 0x44, 0x38, 0x00, 0x00,  // 5
0x38, 0x44, 0x40, 0x78, 0x44, 0x44, 0x44, 0x38, 0x00, 0x00,  // 6
0x7C, 0x04, 0x08, 0x10, 0x10, 0x20, 0x20, 0x20, 0x00, 0x00,  // 7
0x38, 0x44, 0x44, 0x38, 0x44, 0x44, 0x44, 0x38, 0x00, 0x00,  // 8
0x38, 0x44, 0x44, 0x44, 0x3C, 0x04, 0x44, 0x38, 0x00, 0x00,  // 9
0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00,  // :
0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x10, 0x10, 0x10,  // ;
0x00, 0x00, 0x0C, 0x30, 0x40, 0x30, 0x0C, 0x00, 0x00, 0x00,  // <
0x00, 0x00, 0x00, 0x7C, 0x00, 0x7C, 0x00, 0x00, 0x00, 0x00,  // =
0x00, 0x00, 0x60, 0x18, 0x04, 0x18, 0x60, 0x00, 0x00, 0x00,  // >
0x38, 0x44, 0x04, 0x08, 0x10, 0x10, 0x00, 0x10, 0x00, 0x00,  // ?
0x38, 0x44, 0x4C, 0x54, 0x5C, 0x40, 0x40, 0x38, 0x00, 0x00,  // @
0x10, 0x28, 0x28, 0x28, 0x28, 0x7C, 0x44, 0x44, 0x00, 0x00,  // A
0x78, 0x44, 0x44, 0x78, 0x44, 0x44, 0x44, 0x78, 0x00, 0x00,  // B
0x38, 0x44, 0x40, 0x40, 0x40, 0x40, 0x44, 0x38, 0x00, 0x00,  // C
0x70, 0x48, 0x44, 0x44, 0x44, 0x44, 0x48, 0x70, 0x00, 0x00,  // D
0x7C, 0x40, 0x40, 0x7C, 0x40, 0x40, 0x40, 0x7C, 0x00, 0x00,  // E
0x7C, 0x40, 0x40, 0x78, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00,  // F
0x38, 0x44, 0x40, 0x40, 0x5C, 0x44, 0x44, 0x38, 0x00, 0x00,  // G
0x44, 0x44, 0x44, 0x7C, 0x44, 0x44, 0x44, 0x44, 0x00, 0x00,  // H
0x38, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x38, 0x00, 0x00,  // I
0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x44, 0x38, 0x00, 0x00,  // J
0x44, 0x48, 0x50, 0x60, 0x50, 0x48, 0x48, 0x44, 0x00, 0x00,  // K
0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7C, 0x00, 0x00,  // L
0x44, 0x6C, 0x6C, 0x54, 0x44, 0x44, 0x44, 0x44, 0x00, 0x00,  // M
0x44, 0x64, 0x64, 0x54, 0x54, 0x4C, 0x4C, 0x44, 0x00, 0x00,  // N
0x38, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x38, 0x00, 0x00,  // O
0x78, 0x44, 0x44, 0x44, 0x78, 0x40, 0x40, 0x40, 0x00, 0x00,  // P
0x38, 0x44, 0x44, 0x44, 0x44, 0x44, 0x54, 0x38, 0x04, 0x00,  // Q
0x78, 0x44, 0x44, 0x44, 0x78, 0x48, 0x48, 0x44, 0x00, 0x00,  // R
0x38, 0x44, 0x40, 0x30, 0x08, 0x04, 0x44, 0x38, 0x00, 0x00,  // S
0x7C, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00, 0x00,  // T
0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x38, 0x00, 0x00,  // U
0x44, 0x44, 0x44, 0x28, 0x28, 0x28, 0x10, 0x10, 0x00, 0x00,  // V
0x44, 0x44, 0x54, 0x54, 0x54, 0x6C, 0x28, 0x28, 0x00, 0x00,  // W
0x44, 0x28, 0x28, 0x10, 0x10, 0x28, 0x28, 0x44, 0x00, 0x00,  // X
0x44, 0x44, 0x28, 0x28, 0x10, 0x10, 0x10, 0x10, 0x00, 0x00,  // Y
0x7C, 0x04, 0x08, 0x10, 0x10, 0x20, 0x40, 0x7C, 0x00, 0x00,  // Z
0x18, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x18,  // [
0x20, 0x20, 0x10, 0x10, 0x10, 0x10, 0x08, 0x08, 0x00, 0x00,  /* \ */
0x30, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x30,  // ]
0x10, 0x28, 0x28, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ^
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE,  // _
0x20, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // `
0x00, 0x00, 0x38, 0x44, 0x3C, 0x44, 0x4C, 0x34, 0x00, 0x00,  // a
0x40, 0x40, 0x58, 0x64, 0x44, 0x44, 0x64, 0x58, 0x00, 0x00,  // b
0x00, 0x00, 0x38, 0x44, 0x40, 0x40, 0x44, 0x38, 0x00, 0x00,  // c
0x04, 0x04, 0x34, 0x4C, 0x44, 0x44, 0x4C, 0x34, 0x00, 0x00,  // d
0x00, 0x00, 0x38, 0x44, 0x7C, 0x40, 0x44, 0x38, 0x00, 0x00,  // e
0x0C, 0x10, 0x7C, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00, 0x00,  // f
0x00, 0x00, 0x34, 0x4C, 0x44, 0x44, 0x4C, 0x34, 0x04, 0x78,  // g
0x40, 0x40, 0x58, 0x64, 0x44, 0x44, 0x44, 0x44, 0x00, 0x00,  // h
0x10, 0x00, 0x70, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00, 0x00,  // i
0x10, 0x00, 0x70, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0xE0,  // j
0x40, 0x40, 0x48, 0x50, 0x60, 0x50, 0x48, 0x44, 0x00, 0x00,  // k
0x70, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00, 0x00,  // l
0x00, 0x00, 0x78, 0x54, 0x54, 0x54, 0x54, 0x54, 0x00, 0x00,  // m
0x00, 0x00, 0x58, 0x64, 0x44, 0x44, 0x44, 0x44, 0x00, 0x00,  // n
0x00, 0x00, 0x38, 0x44, 0x44, 0x44, 0x44, 0x38, 0x00, 0x00,  // o
0x00, 0x00, 0x58, 0x64, 0x44, 0x44, 0x64, 0x58, 0x40, 0x40,  // p
0x00, 0x00, 0x34, 0x4C, 0x44, 0x44, 0x4C, 0x34, 0x04, 0x04,  // q
0x00, 0x00, 0x58, 0x64, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00,  // r
0x00, 0x00, 0x38, 0x44, 0x30, 0x08, 0x44, 0x38, 0x00, 0x00,  // s
0x20, 0x20, 0x78, 0x20, 0x20, 0x20, 0x20, 0x18, 0x00, 0x00,  // t
0x00, 0x00, 0x44, 0x44, 0x44, 0x44, 0x4C, 0x34, 0x00, 0x00,  // u
0x00, 0x00, 0x44, 0x44, 0x28, 0x28, 0x28, 0x10, 0x00, 0x00,  // v
0x00, 0x00, 0x54, 0x54, 0x54, 0x6C, 0x28, 0x28, 0x00, 0x00,  // w
0x00, 0x00, 0x44, 0x28, 0x10, 0x10, 0x28, 0x44, 0x00, 0x00,  // x
0x00, 0x00, 0x44, 0x44, 0x28, 0x28, 0x10, 0x10, 0x10, 0x60,  // y
0x00, 0x00, 0x7C, 0x08, 0x10, 0x20, 0x40, 0x7C, 0x00, 0x00,  // z
0x18, 0x10, 0x10, 0x10, 0x20, 0x20, 0x10, 0x10, 0x10, 0x18,  // {
0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,  // |
0x30, 0x10, 0x10, 0x10, 0x08, 0x08, 0x10, 0x10, 0x10, 0x30,  // }
0x00, 0x00, 0x00, 0x74, 0x4C, 0x00, 0x00, 0x00, 0x00, 0x00,  // ~
};

void initOLED(I2C_HandleTypeDef *i2cInstance)
{
  memset(screenBuff, 0, BUFF_SIZE);
  memset(cmdBuff, 0, WIRE_MAX);
  i2c1 = i2cInstance;
  initDisplay();
  drawImage(logo_bmp,67,45); 
  display();
  return;
}

static void write_cmd(uint8_t c)
{
  uint8_t buffTemp[3];
  memset(screenBuff, 0, 3);
  buffTemp[0] = 0x00;
  buffTemp[1] = c;
  HAL_I2C_Master_Transmit(i2c1, addr_oled, buffTemp, 2, 100);
  return;
}

static void cmd_list(unsigned char *c, int n)
{
  unsigned char bytesOut = 1;
  memset(cmdBuff, 0, WIRE_MAX);

  while (n--)
  {
    if (bytesOut >= WIRE_MAX)
    {
      HAL_I2C_Master_Transmit(i2c1, addr_oled, cmdBuff, WIRE_MAX, 1000);
      memset(cmdBuff, 0, WIRE_MAX);
      bytesOut = 1;
    }
    cmdBuff[bytesOut] = *c++;
    bytesOut++;
  }
  if (bytesOut > 0)
  {
    HAL_I2C_Master_Transmit(i2c1, addr_oled, cmdBuff, bytesOut, 1000);
  }
}

static void initDisplay()
{
  write_cmd(0xAE); // 0xAE // display off
  write_cmd(0xD5); // 0xD5 // set display clock division
  write_cmd(0x80); // the suggested ratio 0x80
  write_cmd(0xA8); // 0xA8 set multiplex
  write_cmd(63);   // set height
  write_cmd(0xD3); // set display offseti2c1
  write_cmd(0x00); // no offset
  write_cmd(0x40); // line #0 setstartline
  write_cmd(0x8D); // 0x8D // chargepump
  write_cmd(0x14); //?? 0x10
  write_cmd(0x20); // memory mode
  write_cmd(0x00); // 0x0 act like ks0108
  write_cmd(0xA1); // segremap
  write_cmd(0xC8); // comscandec
  write_cmd(0xDA); // 0xDA set com pins
  write_cmd(0x12);
  write_cmd(0x81); // 0x81 // set contract
  write_cmd(0xCF); //??  0x9F
  write_cmd(0xD9); // 0xd9 set pre-charge
  write_cmd(0xF1); // 0x22
  write_cmd(0xDB); // SSD1306_SETVCOMDETECT
  write_cmd(0x40);
  write_cmd(0xA4); // 0xA4 // display all on resume
  write_cmd(0xA6); // 0xA6 // normal display
  write_cmd(0x2E); // deactivate scroll
  write_cmd(0xAF); // --turn on oled panel
}

static void display()
{

  int count = WIDTH * (HEIGHT / 8);
  uint8_t *ptr = screenBuff;
  unsigned char bytesOut = 1;
  unsigned char dlist1[] = {
      SSD1306_PAGEADDR,
      0,    // Page start address
      0xFF, // Page end (not really, but works here)
      SSD1306_COLUMNADDR,
      0};
  // Column start address
  cmd_list(dlist1, sizeof(dlist1));
  write_cmd(WIDTH - 1);
  memset(cmdBuff, 0, WIRE_MAX);
  cmdBuff[0] = 0x40;
  while (count--)
  {
    if (bytesOut >= WIRE_MAX)
    {
      HAL_I2C_Master_Transmit(i2c1, addr_oled, cmdBuff, WIRE_MAX, 1000);
      memset(cmdBuff, 0, WIRE_MAX);
      cmdBuff[0] = 0x40;
      bytesOut = 1;
    }
    cmdBuff[bytesOut] = *ptr++;
    bytesOut++;
  }
  if (bytesOut > 0)
  {
    HAL_I2C_Master_Transmit(i2c1, addr_oled, cmdBuff, bytesOut, 1000);
  }
}

void clearDisplay()
{
  memset(screenBuff, 0, BUFF_SIZE);
  display();
}

static void drawpixel(int x, int y)
{ // draw hang y cot x

  if ((x >= 0) && (x < WIDTH) && (y >= 0) && (y < HEIGHT))
  {
    screenBuff[x + (y / 8) * WIDTH] |= (1 << (y & 7)); //
  }
}

void drawBitmap(int x, int y, unsigned char bitmap[], int w, int h)
{

  int i, j;
  int byteWidth = (w + 7) / 8;
  int byte = 0;
  for (j = 0; j < h; j++)
  {
    for (i = 0; i < w; i++)
    {

      if (i & 7) // 8 bit 1
        byte <<= 1;
      else
        byte = bitmap[j * byteWidth + i / 8];
      if (byte & 0x80)
      {
        drawpixel(x + i, y + j);
      }
    }
  }
}

void drawImage(unsigned char bitmap[], int LOGO_HEIGHT, int LOGO_WIDTH)
{

  drawBitmap(
      (WIDTH - LOGO_WIDTH) / 2,
      (HEIGHT - LOGO_HEIGHT) / 2,
      bitmap, LOGO_WIDTH, LOGO_HEIGHT);
}

void drawChar(int16_t x, int16_t y, unsigned char c)
{

  if ((x >= WIDTH) || x < 0 ||           // Clip right
      (y >= HEIGHT) || y < 0 ||          // Clip bottom
      ((x + size_x - WIDTH - 1) > 0) ||  // Clip left
      ((y + size_y - HEIGHT - 1) > 0) || // Clip top
      c < 32 || c > 126)                 // not character
    return;
  int16_t t = (c - 32) * 10;
  for (int8_t i = 0; i < 10; i++)
  {
    int8_t cha = Fonts_10x7[i + t];
    for (int8_t j = 0; j < 8; j++)
    {
      if (cha & 0x80)
      {
        drawpixel(x + j, y + i);
      }
      cha <<= 1;
      //  0x1000
    }
  }
}

void drawChars(uint8_t *x, uint8_t *y, char mess)
{

  if (*x + size_x >= WIDTH)
  {
    if ((*y + size_y >= HEIGHT))
    {
      *x = 0;
      *y = 0;
      clearDisplay();
    }
    else
    {
      *y += size_y;
      *x = 0;
    }
  }
  drawChar(*x, *y, mess);
  *x += size_x;
  return;
}
